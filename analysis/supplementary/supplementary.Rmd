---
title: "Supplementary material to the paper 'Comparing summed probability distributions of shoreline and radiocarbon dates from the Mesolithic Skagerrak coast of Norway'"
author: 
- 'Isak Roalkvam'
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::pdf_document2:
    toc: false
---

This document lays out the measures that were taken in an attempt to work around and explore the convergence issues related to identifying parameters for models beyond 4-CPL.

```{r setup}
# Load required packages
library(ADMUR)
library(DEoptimR)
library(pso)

# Set seed for reproducibility
set.seed(42)
```

```{r data}
# Load data holding the SSPD
load(file = here::here("analysis/data/derived_data/shore_pd_models.RData"))

```

```{r precompiled, echo = FALSE}
# For the compilation of this Rmarkdown document, the results were pre-compiled 
# and are loaded here. Set eval = TRUE in code chunks below to re-run the code.
load(file = here::here("analysis/data/derived_data/supplementary.RData"))

```

This section gives the result of running JDEoptimR on the SSPD to identify 4-CPL, 5-CPL and 6-CPL. For 5-CPL and 6-CPL both the maxint and NP parameters were increased beyond the minimum recommended settings in an attempt to achieve convergence. 

```{r jdeoptim, eval = FALSE}
  cpl_4 <- JDEoptim(lower = rep(0, 7),
                     upper = rep(1, 7), 
                     fn = objectiveFunction,
                     PDarray = pd,
                     type = 'CPL',
                     NP = 140)

  cpl_5 <- JDEoptim(lower = rep(0, 9), 
                    upper = rep(1, 9), 
                    fn = objectiveFunction,
                    PDarray = pd,
                    type='CPL',
                    NP = 250, 
                    maxiter = 400 * 9) 

  cpl_6 <- JDEoptim(lower = rep(0, 11),
                       upper = rep(1,11),
                       fn = objectiveFunction,
                       PDarray = pd,
                       type = 'CPL',
                       NP = 300, 
                       maxiter =  400 * 11)

```

In the output the value in the column 'convergence' indicates success with 0 and failure with 1, meaning that while 4-CPL converged without any issues, both 5-CPL and 6-CPL failed to converge.

To check if the issue could be related to the scale of the values in the pd, the same procedure was ran with the probabilities subjected to min-max normalisation to adjust these to take on values between 0 and 1.

```{r minmax, eval = FALSE}

```

As a subsequent step, the differential evolution optimization algorithm from DEoptimR was replaced with particle swarm optimization using the pso package.
The value for convergence is here 0 with successful convergence, and 2 if convergence was not achieved before reaching the maximum number of iterations (see ?psoptim).

```{r pso, eval = FALSE}

cpl4_pso <- psoptim(par = rep(NA, 7),
                    lower = rep(0, 7),
                    upper = rep(0.9999999, 7), # Upper bound causes error at 1
                    fn = objectiveFunction,
                    PDarray = pd,
                    type = 'CPL',
                    control = list(maxit = 20000))

cpl5_pso <- psoptim(par = rep(NA, 9),
                    lower = rep(0, 9),
                    upper = rep(0.9999999, 9),
                    fn = objectiveFunction,
                    PDarray = pd,
                    type = 'CPL',
                    control = list(maxit = 20000))

cpl6_pso <- psoptim(par = rep(NA, 11),
                    lower = rep(0, 11),
                    upper = rep(0.9999999, 11),
                    fn = objectiveFunction,
                    PDarray = pd,
                    type = 'CPL',
                    control = list(maxit = 20000))
```

As a final step and to explore the behaviour of JDEoptim() with shoreline dates, a series of models were fit to an increasing number of randomly sampled shoreline dates. 

```{r sample, eval = FALSE}
sampsize <- c(6, 32, 60, 120, 240, 480)

results <- list()
for(i in 1:2){
  tmppd <- pd[, sample(ncol(pd), sampsize[i])]

  cpl4 <- JDEoptim(lower = rep(0, 7),
                      upper = rep(1, 7),
                      fn = objectiveFunction,
                      PDarray = tmppd,
                      type = 'CPL',
                      NP = 140)

  cpl5 <- JDEoptim(lower = rep(0, 9),
                      upper = rep(1, 9),
                      fn = objectiveFunction,
                      PDarray = tmppd,
                      type='CPL',
                      NP = 180,
                      maxiter = 400 * 9,
                      trace = TRUE)

  cpl6 <- JDEoptim(lower = rep(0, 11),
                      upper = rep(1,11),
                      fn = objectiveFunction,
                      PDarray = tmppd,
                      type = 'CPL',
                      NP = 220,
                      maxiter = 400 * 11,
                      trace = TRUE)

  results[[i]] <- rbind(cpl4, cpl5, cpl6)
}
```

```{r}
# Print results
for(i in 1:length(results)){
  cat(paste("\nSample size =", sampsize[i], "\n"))
  print(results[[i]])
}
```

4-CPL successfully converged for all sample sizes, while 5-CPL and 6-CPL consistently failed to converge. 
