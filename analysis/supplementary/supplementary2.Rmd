---
title: "Exploring convergence issues beyond 4-CPL for SPD of shoreline dates"
author: 
- 'Isak Roalkvam'
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup}
# Load required packages
library(ggplot2)
library(patchwork)
library(ADMUR)
library(DEoptimR)

# Set seed for reproducibility
set.seed(42)
```

```{r data}
# Load data holding the PD array of shoreline dates and min and max age
load(file = here::here("analysis/data/derived_data/shore_pd.Rdata"))

# Create SPD
spd <- as.data.frame(rowSums(pd))
spd <- spd/(sum(spd) * 5)

# Plot PD array and SPD for inspection
plotPD(pd)
plotPD(spd)
```

```{r precompiled, echo = FALSE}
# For the compilation of this Rmarkdown document, the results of the two code 
# chunks below were pre-compiled and are loaded here. Set eval = TRUE below to 
# re-run the code.
load(file = here::here("analysis/data/derived_data/sampsize.RData"))
load(file = here::here("analysis/data/derived_data/shore_models1.RData"))

```

## Default approach (5-CPL and 6-CPL do not convergence)

```{r, eval = FALSE}
cpl_1 <- JDEoptim(lower = 0, upper = 1, fn = objectiveFunction, PDarray = pd,
                  type = 'CPL', NP = 20)
cpl_2 <- JDEoptim(lower = rep(0, 3), upper = rep(1, 3), fn = objectiveFunction,
                  PDarray = pd, type = 'CPL', NP = 60)
cpl_3 <- JDEoptim(lower = rep(0, 5), upper = rep(1, 5), fn = objectiveFunction,
                  PDarray = pd, type = 'CPL', NP = 100)
cpl_4 <- JDEoptim(lower = rep(0, 7), upper = rep(1, 7), fn = objectiveFunction,
                  PDarray = pd, type = 'CPL', NP = 140)
cpl_5 <- JDEoptim(lower = rep(0, 9), upper = rep(1, 9), fn = objectiveFunction,
                  PDarray = pd, type='CPL', NP = 180)
cpl_6 <- JDEoptim(lower = rep(0, 11), upper = rep(1,11), fn = objectiveFunction,
                  PDarray = pd, type = 'CPL', NP = 220)
```

```{r}
cpl1 <- convertPars(pars = cpl_1$par, years = minage:maxage, type = 'CPL')
cpl1$model <- "1-CPL"
cpl2 <- convertPars(pars = cpl_2$par, years = minage:maxage, type = 'CPL')
cpl2$model <- "2-CPL"
cpl3 <- convertPars(pars = cpl_3$par, years = minage:maxage, type = 'CPL')
cpl3$model <- "3-CPL"
cpl4 <- convertPars(pars = cpl_4$par, years = minage:maxage, type = 'CPL')
cpl4$model <- "4-CPL"
cpl5 <- convertPars(pars = cpl_5$par, years = minage:maxage, type = 'CPL')
cpl5$model <- "5-CPL"
cpl6 <- convertPars(pars = cpl_6$par, years = minage:maxage, type = 'CPL')
cpl6$model <- "6-CPL"

shmodels <- rbind(cpl1, cpl2, cpl3, cpl4, cpl5, cpl6)

sh_lik <- c("1-CPL" = -cpl_1$value,
            "2-CPL" = -cpl_2$value,
            "3-CPL" = -cpl_3$value,
            "4-CPL" = -cpl_4$value,
            "5-CPL" = -cpl_5$value,
            "6-CPL" = -cpl_6$value)

ssize <- ncol(pd)
sh_bic <- c(log(ssize)*1 - 2*sh_lik[1], # 1-CPL
            log(ssize)*3 - 2*sh_lik[2], # 2-CPL
            log(ssize)*5 - 2*sh_lik[3], # 3-CPL
            log(ssize)*7 - 2*sh_lik[4], # 4-CPL
            log(ssize)*9 - 2*sh_lik[5], # 5-CPL
            log(ssize)*11 - 2*sh_lik[6]) # 6-CPL

```

```{r}
modelplt <- ggplot() +
  geom_bar(aes(x = as.numeric(rownames(spd)),
               spd[,1]),
           stat = "identity", col = "grey") +
  geom_line(aes(x = as.numeric(rownames(spd)),
                y = spd[,1])) +
  geom_line(data = shmodels, aes(year, pdf, col = model),
            linewidth = 1.1) +
  labs(x = "calBP", y = "PD") +
  scale_colour_manual(values = c(
    "1-CPL" = "#e41a1c",
    "2-CPL" = "#4daf4a",
    "3-CPL" = "#e0d616",
    "4-CPL" = "#377eb8",
    "5-CPL" = "black",
    "6-CPL" = "#984ea3"
  )) +
  scale_x_reverse() +
  theme_bw() +
  theme(legend.title = element_blank())

bicplt <- ggplot() +
  geom_point(aes(sh_bic, names(sh_bic)), size = 2) +
  labs(x = "BIC", y = "") +
  scale_y_discrete(limits = rev) +
  theme_bw()

modelplt
bicplt
```

## Increasing number of randomly sampled dates

```{r sampsize, eval = FALSE}

# Define sample sizes
sampsize <- c(6, 32, 60, 120, 240, 480)

results <- list()
temppds <- list()

# Fit 4-6 CPL to randomly drawn number of shoreline dates using the default
# parameters
for(i in 1:length(sampsize)){
  tmppd <- pd[, sample(ncol(pd), sampsize[i])]
  temppds[[i]] <- tmppd

  cpl4 <- JDEoptim(lower = rep(0, 7),
                   upper = rep(1, 7),
                   fn = objectiveFunction,
                   PDarray = tmppd,
                   type = 'CPL',
                   NP = 140)

  cpl5 <- JDEoptim(lower = rep(0, 9),
                   upper = rep(1, 9),
                   fn = objectiveFunction,
                   PDarray = tmppd,
                   type='CPL',
                   NP = 180)

  cpl6 <- JDEoptim(lower = rep(0, 11),
                   upper = rep(1,11),
                   fn = objectiveFunction,
                   PDarray = tmppd,
                   type = 'CPL',
                   NP = 220)

  results[[i]] <- rbind(cpl4, cpl5, cpl6)
}
```

```{r, fig.dim = c(8, 5)}
# Plot the results
for(i in 1:length(temppds)){
  tmpspd <- as.data.frame(rowSums(temppds[[i]]) )
  tmpspd <- tmpspd/( sum(tmpspd) * 5 )

  tmpmodels <- as.data.frame(results[[i]])

  tmpcpl4 <- convertPars(pars = tmpmodels$par[[1]],
                         years = minage:maxage, type = 'CPL')
  tmpcpl4$model <- "4-CPL"
  tmpcpl4$convergence <- tmpmodels$convergence[[1]]

  tmpcpl5 <- convertPars(pars = tmpmodels$par[[2]],
                         years = minage:maxage, type = 'CPL')
  tmpcpl5$model <- "5-CPL"
  tmpcpl5$convergence <- tmpmodels$convergence[[2]]

  tmpcpl6 <- convertPars(pars = tmpmodels$par[[3]],
                         years = minage:maxage, type = 'CPL')
  tmpcpl6$model <- "6-CPL"
  tmpcpl6$convergence <- tmpmodels$convergence[[3]]

  tmpcpls <- rbind(tmpcpl4, tmpcpl5, tmpcpl6)

  print(ggplot() +
    geom_bar(aes(x = as.numeric(rownames(tmpspd)), y =  tmpspd[,1]), 
             stat = "identity", col = "grey") +
    geom_line(aes(x = as.numeric(rownames(tmpspd)), y =  tmpspd[,1])) +
    geom_line(data = tmpcpls, aes(x = year, y = pdf, col = model),
              linewidth = 1.1) +
    labs(x = "calBP", y = "PD", title = paste("Randomly sampled dates = ",
                                              sampsize[i])) +
    scale_colour_manual(values = c("4-CPL" = "black",
                                    "5-CPL" = "goldenrod2",
                                    "6-CPL" = "cornflowerblue")) +
    scale_x_reverse() +
    theme_bw() +
    theme(legend.position = "bottom",
          legend.title=element_blank()) +
  ggplot() +
    geom_point(data = tmpcpls,
               aes(x = model,
                   y = as.factor(convergence),
                   col = as.factor(convergence)),
               size = 3) +
    scale_colour_manual(values = c("1" = "red",
                                   "0" = "chartreuse3")) +
    labs(x = "Model", y = "Convergence") +
    theme_bw() +
    theme(legend.position = "none"))
}
```

## Exploring parameter settings for 5-CPL search

The figures below displays the results of attempting to adjust parameter settings for improving the parameter search for the 5-CPL model. The identified model parameters are identical across the runs, the variation in the returned values is minute, and none of the searches reached convergence. The parameters used with `JDEoptim()` were altered one at a time, resulting in 11 separate searches. I have not included the code for each individual run and the plotting of the results, but the following code was used as the starting point from where parameters were adjusted:
```{r, eval = FALSE}
# Base code from where the parameters were adjusted individually
JDEoptim(lower = rep(0, 9),
                   upper = rep(1, 9),
                   fn = objectiveFunction,
                   PDarray = pd,
                   type = 'CPL',
                   NP = 180)
```

```{r, echo = FALSE}

load(file = here::here("analysis/data/derived_data/exploring_cpl5.RData"))

cpl5iter <- convertPars(pars = cpl_5$par, years = minage:maxage, type = 'CPL')
cpl5iter$parameter <- "maxiter = 3600"
cpl5iter$value <- cpl_5$value
cpl5iter$convergence <- cpl_5$convergence

cpl5iter2 <- convertPars(pars = cpl_5iter2$par, years = minage:maxage, type = 'CPL')
cpl5iter2$parameter <- "maxiter = 7200"
cpl5iter2$value <- cpl_5iter2$value
cpl5iter2$convergence <- cpl_5iter2$convergence

cpl5np <- convertPars(pars = cpl_5np$par, years = minage:maxage, type = 'CPL')
cpl5np$parameter <- "NP = 360"
cpl5np$value <- cpl_5np$value
cpl5np$convergence <- cpl_5np$convergence

cpl5np2 <- convertPars(pars = cpl_5np2$par, years = minage:maxage, type = 'CPL')
cpl5np2$parameter <- "NP = 720"
cpl5np2$value <- cpl_5np2$value
cpl5np2$convergence <- cpl_5np2$convergence

cpl5jitter <- convertPars(pars = cpl_5jitter$par, years = minage:maxage, type = 'CPL')
cpl5jitter$parameter <- "jitter_factor = NULL"
cpl5jitter$value <- cpl_5jitter$value
cpl5jitter$convergence <- cpl_5jitter$convergence

cpl5jitter2 <- convertPars(pars = cpl_5jitter2$par, years = minage:maxage, type = 'CPL')
cpl5jitter2$parameter <- "jitter_factor = 0.01"
cpl5jitter2$value <- cpl_5jitter2$value
cpl5jitter2$convergence <- cpl_5jitter2$convergence

cpl5jitter3 <- convertPars(pars = cpl_5jitter3$par, years = minage:maxage, type = 'CPL')
cpl5jitter3$parameter <- "jitter_factor = 0.1"
cpl5jitter3$value <- cpl_5jitter3$value
cpl5jitter3$convergence <- cpl_5jitter3$convergence

cpl5jitter4 <- convertPars(pars = cpl_5jitter4$par, years = minage:maxage, type = 'CPL')
cpl5jitter4$parameter <- "jitter_factor = 0.0001"
cpl5jitter4$value <- cpl_5jitter4$value
cpl5jitter4$convergence <- cpl_5jitter4$convergence

cpl5mutprob1 <- convertPars(pars = cpl_5mutprob1$par, years = minage:maxage, type = 'CPL')
cpl5mutprob1$parameter <- "tau_pF = 0.5"
cpl5mutprob1$value <- cpl_5mutprob1$value
cpl5mutprob1$convergence <- cpl_5mutprob1$convergence

cpl5mutprob2 <- convertPars(pars = cpl_5mutprob2$par, years = minage:maxage, type = 'CPL')
cpl5mutprob2$parameter <- "tau_pF = 0.2"
cpl5mutprob2$value <- cpl_5mutprob2$value
cpl5mutprob2$convergence <- cpl_5mutprob2$convergence

cpl5mutprob3 <- convertPars(pars = cpl_5mutprob3$par, years = minage:maxage, type = 'CPL')
cpl5mutprob3$parameter <- "tau_pF = 1"
cpl5mutprob3$value <- cpl_5mutprob3$value
cpl5mutprob3$convergence <- cpl_5mutprob3$convergence

cpl5models <- rbind(cpl5iter, cpl5iter2, cpl5np, cpl5np2, cpl5jitter,
                    cpl5jitter2, cpl5jitter3, cpl5jitter4, cpl5mutprob1,
                    cpl5mutprob2, cpl5mutprob3)

plt1 <- ggplot() + geom_line(aes(x = as.numeric(rownames(spd)), y = spd[,1])) + geom_line(data = cpl5models, aes(x = year, y = pdf, col = parameter)) +
  scale_x_reverse() +
  theme_bw()
plt2 <- ggplot() + geom_point(data = cpl5models, aes(x = value, y = parameter)) + geom_vline(xintercept = cpl_5$value, col = "red") +
  ylab("") +
  theme_bw()
plt3 <- ggplot() + geom_point(data = cpl5models, aes(x = as.factor(convergence), y = parameter, col = as.factor(convergence))) +
  ylab("") +
  theme_bw() + theme(legend.position =  "none", axis.text.y=element_blank(), axis.ticks.y=element_blank())

plt1 
  
```

```{r, echo = FALSE}
plt2 + plt3
```
